<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:skia="clr-namespace:SkiaSharp.Views.Maui.Controls;assembly=SkiaSharp.Views.Maui.Controls"
             xmlns:mmd="clr-namespace:MiniMikuDanceMaui"
             x:Class="MiniMikuDanceMaui.CameraPage"
             BackgroundColor="Transparent">

    <ContentPage.MenuBarItems>
        <MenuBarItem Text="File" />
        <MenuBarItem Text="Edit" />
        <MenuBarItem Text="Selection" />
        <MenuBarItem Text="View">
            <MenuFlyoutItem Text="HOME" Clicked="OnHomeClicked" />
        </MenuBarItem>
        <MenuBarItem Text="Setting">
            <MenuFlyoutItem Text="Open" Clicked="OnSettingClicked" />
        </MenuBarItem>
        <MenuBarItem Text="Help" />
    </ContentPage.MenuBarItems>
    <AbsoluteLayout x:Name="Root">
        <!-- TopMenu を Overlay より前面に表示するため ZIndex を上げる -->
        <HorizontalStackLayout x:Name="TopMenu" BackgroundColor="#2A2A2A" Spacing="20" Padding="10,0" HeightRequest="36" ZIndex="10">
            <Label Text="File" TextColor="White">
                <Label.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnFileMenuTapped" />
                </Label.GestureRecognizers>
            </Label>
            <Label Text="Edit" TextColor="White"/>
            <Label Text="Selection" TextColor="White"/>
            <Label Text="View" TextColor="White">
                <Label.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnViewMenuTapped" />
                </Label.GestureRecognizers>
            </Label>
            <Label Text="Setting" TextColor="White">
                <Label.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnSettingMenuTapped" />
                </Label.GestureRecognizers>
            </Label>
            <Label Text="Help" TextColor="White"/>
        </HorizontalStackLayout>
        <Frame x:Name="ViewMenu" IsVisible="False" BackgroundColor="#1E1E1E" Padding="0" ZIndex="20">
            <VerticalStackLayout Spacing="4" Padding="8">
                <Label Text="HOME" TextColor="White">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnHomeClicked" />
                    </Label.GestureRecognizers>
                </Label>
                <Label Text="EXPLORER" TextColor="White">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnExplorerClicked" />
                    </Label.GestureRecognizers>
                </Label>
                <Label Text="BONE" TextColor="White">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnBoneClicked" />
                    </Label.GestureRecognizers>
                </Label>
                <Label Text="MTOON" TextColor="White">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnMToonClicked" />
                    </Label.GestureRecognizers>
                </Label>
                <Label Text="TIMELINE" TextColor="White">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnTimelineClicked" />
                    </Label.GestureRecognizers>
                </Label>
                <Label Text="CAMERA" TextColor="White">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnCameraClicked" />
                    </Label.GestureRecognizers>
                </Label>
                <Label Text="TERMINAL" TextColor="White">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnTerminalClicked" />
                    </Label.GestureRecognizers>
                </Label>
            </VerticalStackLayout>
        </Frame>
        <Frame x:Name="FileMenu" IsVisible="False" BackgroundColor="#1E1E1E" Padding="0" ZIndex="20">
            <VerticalStackLayout Spacing="4" Padding="8">
                <Label Text="Import VRM" TextColor="White">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnOpenInViewerClicked" />
                    </Label.GestureRecognizers>
                </Label>
                <Label Text="Estimate Pose" TextColor="White">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnEstimatePoseClicked" />
                    </Label.GestureRecognizers>
                </Label>
                <Label Text="Adapt Pose" TextColor="White">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnAdaptPoseClicked" />
                    </Label.GestureRecognizers>
                </Label>
            </VerticalStackLayout>
        </Frame>
        <Frame x:Name="SettingMenu" IsVisible="False" BackgroundColor="#1E1E1E" Padding="8" ZIndex="20">
            <VerticalStackLayout Spacing="10">
                <mmd:SettingView x:Name="SettingContent" />
            </VerticalStackLayout>
        </Frame>
        <!-- Overlay は BottomRegion より背面に配置しつつ Viewer より前面に表示する -->
        <BoxView x:Name="MenuOverlay" BackgroundColor="Transparent" IsVisible="False" ZIndex="1">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnOverlayTapped" />
            </BoxView.GestureRecognizers>
        </BoxView>
        <Frame x:Name="FileSelectMessage" IsVisible="False" BackgroundColor="#1E1E1E" Padding="8" ZIndex="30">
            <VerticalStackLayout Spacing="6">
                <Label Text="VRMファイルを以下から選択してください" TextColor="White" />
                <Label x:Name="SelectedFilePath" TextColor="White" FontSize="12" />
                <HorizontalStackLayout HorizontalOptions="Center" Spacing="20">
                    <Button Text="インポート" Clicked="OnImportClicked" />
                    <Button Text="キャンセル" Clicked="OnCancelImportClicked" />
                </HorizontalStackLayout>
            </VerticalStackLayout>
        </Frame>
        <Frame x:Name="PoseSelectMessage" IsVisible="False" BackgroundColor="#1E1E1E" Padding="8" ZIndex="30">
            <VerticalStackLayout Spacing="6">
                <Label Text="動画ファイルを以下から選択してください" TextColor="White" />
                <Label x:Name="SelectedVideoPath" TextColor="White" FontSize="12" />
                <HorizontalStackLayout HorizontalOptions="Center" Spacing="20">
                    <Button Text="Start" Clicked="OnStartEstimateClicked" />
                    <Button Text="キャンセル" Clicked="OnCancelEstimateClicked" />
                </HorizontalStackLayout>
            </VerticalStackLayout>
        </Frame>
        <Frame x:Name="AdaptSelectMessage" IsVisible="False" BackgroundColor="#1E1E1E" Padding="8" ZIndex="30">
            <VerticalStackLayout Spacing="6">
                <Label Text="ポーズファイルを以下から選択してください" TextColor="White" />
                <Label x:Name="SelectedPosePath" TextColor="White" FontSize="12" />
                <HorizontalStackLayout HorizontalOptions="Center" Spacing="20">
                    <Button Text="適用" Clicked="OnStartAdaptClicked" />
                    <Button Text="キャンセル" Clicked="OnCancelAdaptClicked" />
                </HorizontalStackLayout>
            </VerticalStackLayout>
        </Frame>
        <Frame x:Name="ToneAddPanel" IsVisible="False" BackgroundColor="#88000000" Padding="8" ZIndex="30">
            <VerticalStackLayout Spacing="6">
                <Picker x:Name="ToneBonePicker" Title="Bone" />
                <Entry x:Name="ToneFrameEntry" Placeholder="Frame" Keyboard="Numeric" />
                <Entry x:Name="BoneEntry" Placeholder="Bone" />
                <Entry x:Name="FrameEntry" Placeholder="Frame" Keyboard="Numeric" />
                <Entry x:Name="PosXEntry" Placeholder="Pos X" Keyboard="Numeric" />
                <Entry x:Name="PosYEntry" Placeholder="Pos Y" Keyboard="Numeric" />
                <Entry x:Name="PosZEntry" Placeholder="Pos Z" Keyboard="Numeric" />
                <Entry x:Name="RotXEntry" Placeholder="Rot X" Keyboard="Numeric" />
                <Entry x:Name="RotYEntry" Placeholder="Rot Y" Keyboard="Numeric" />
                <Entry x:Name="RotZEntry" Placeholder="Rot Z" Keyboard="Numeric" />
                <HorizontalStackLayout Spacing="10" HorizontalOptions="End">
                    <Button Text="確定" Clicked="OnToneConfirmClicked" />
                    <Button Text="キャンセル" Clicked="OnToneCancelClicked" />
                </HorizontalStackLayout>
            </VerticalStackLayout>
        </Frame>
        <ActivityIndicator x:Name="LoadingIndicator" IsRunning="True" IsVisible="False" Color="Blue" ZIndex="30" />
        <skia:SKGLView x:Name="Viewer" HasRenderLoop="True" EnableTouchEvents="True" />
        <Grid x:Name="BottomRegion" BackgroundColor="#1E1E1E" IsVisible="False" ZIndex="2">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnBottomRegionTapped" />
            </Grid.GestureRecognizers>
            <Grid.RowDefinitions>
                <RowDefinition Height="40" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="40" />
                </Grid.ColumnDefinitions>
                <ScrollView Orientation="Horizontal">
                    <HorizontalStackLayout x:Name="BottomTabBar" Spacing="8" Padding="8" BackgroundColor="#2A2A2A" />
                </ScrollView>
                <Label Text="×" Grid.Column="1" TextColor="White" HorizontalTextAlignment="Center" VerticalTextAlignment="Center">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnCloseBottomTapped" />
                    </Label.GestureRecognizers>
                </Label>
            </Grid>
            <ScrollView x:Name="BottomScroll" Grid.Row="1" Orientation="Vertical" VerticalScrollBarVisibility="Always">
                <ScrollView.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnBottomRegionTapped" />
                </ScrollView.GestureRecognizers>
                <ContentView x:Name="BottomContent" />
            </ScrollView>
        </Grid>
    </AbsoluteLayout>
</ContentPage>
