# MiniMikuDance

MiniMikuDance は、スマートフォン上で PMX 形式の MMD 互換モデルを再生・撮影できるモバイル向けアプリです。VRM などの他形式はサポートせず、PMX に特化しています。姿勢推定や録画処理も端末で完結し、Unity を使用せずに C# と OpenTK で実装されています。
実行には `ffmpeg` コマンドが必要です。Android 環境では別途バイナリを用意し PATH に追加するかアプリに同梱してください。


## 目次
- 目的 / ビジョン
- スコープ
- ターゲット環境
- 主要機能
- ユーザー体験（UX）方針
- データ/ファイル形式
- IK/アニメーション設計
  - IKゴール（11点）
  - ソルバ
  - 解く順序（1フレーム）
  - 関節制限
  - タッチ操作（FPD仕様）
  - IKゴール選択（タップピッキング）
- 描画/技術スタック
- 共有/配布ポリシー
- データフロー
- 設定/プロジェクト構成
- ビルド/配布
- 品質/テスト
- ロードマップ
- 用語集
- 更新履歴

---

## 目的 / ビジョン
- スマホ上で **直感的にダンスモーションを作れる** MMD系エディタ。
- キー打ち無しで、**IKハンドル** + **ノード/ステート遷移**で制作する。

## スコープ
- **PMXのみ** のモデル読み込み・表示
- トラッカー不要の **仮想11点IK** によるポーズ作成
- **ノード/ステートベース** のモーション遷移（タイムライン無し）
- **モーション入力のみ可**（ファイル出力は不可）
- モーションの**共有は専用SNS的プラットフォーム**への投稿のみ

## ターゲット環境
- **モバイル**: iOS / Android（MAUI + OpenTK 予定）
- **入力**: **タッチのみ**（マルチタッチジェスチャ対応予定）
- **最小スペック目安**: TBA

## 主要機能
- [ ] **PMX** の読み込み（テクスチャ自動解決、スケール調整）
- [ ] **11点IKハンドル**でのポーズ編集（頭/両手/腰/胸/両足/両膝/両肘）
- [ ] **ノード/ステート遷移**エディタ（Blueprint 風の簡易グラフ）
- [ ] **モーション入力**（例：VMD/CSV/独自フォーマット ※TBD）
- [ ] **共有**：アプリから専用プラットフォームへ投稿（ローカル出力なし）

## ユーザー体験（UX）方針
- **自由視点カメラ**
- **FPD（Focus-Perpendicular Drag）**：カメラ焦点 F と選択ゴール G を結ぶ直線を法線 n とする平面 Π 上でドラッグ
- **タップピッキング**：二段階（2D候補→3D交差＋遮蔽）で誤選択を抑制
- **最小タップ数**でノード作成・遷移設定・再生確認

## データ/ファイル形式
- **モデル入力**: `.pmx`
- **テクスチャ**: `tex/`, `spa/` 等（詳細TBD）
- **モーション入力**: `.vmd` / `.csv` / 独自（TBD）
- **モーション出力**: **なし**（端末内保存不可）

## IK/アニメーション設計

### IKゴール（11点）
- 対象：頭・両手・腰・胸・両足・両膝・両肘  
- 各ゴールは**位置必須／向き任意**。必要に応じて腕・脚に**Pole（肘/膝面）**を持つ。

### ソルバ（ロジック）
- **腕・脚（2ボーン解析解 + Pole）**  
  - ターゲットが射程外のときは**最大到達長にクランプ**。  
  - 屈曲面は**Pole方向**で決定。  
  - 末端（手首/足首）の向き合わせは、ゴールに向き情報がある場合のみ適用。
- **脊椎（腰→胸：短鎖 FABRIK）**  
  - 胸ゴールの位置・向きに向けて**少反復（2–3）で分配**。  
  - 個々の節に**小さめ係数**で変化を割り当て、過度な反りを抑制。
- **肩**  
  - 上腕の最終方向から**スイング成分のみ**を少量付与（上限角あり）。
- **頭頸**  
  - 胸の最終姿勢に対して**Look-At**でヨー/ピッチを調整、ロールは抑制。

### 解く順序（1フレーム）
1. **両脚チェーン**（足→膝→大腿）
2. **骨盤の微調整**（両脚誤差最小化の範囲で）
3. **脊椎**（腰→胸）
4. **両腕チェーン**（手→肘→上腕）
5. **肩スイング**
6. **頭頸 Look-At**
7. **末端の向き合わせ**（手首・足首）

### 関節制限（ロジック）
- **PMXの制限情報を最優先**。無い場合は人体既定値を使用。  
- 硬いクリップではなく**ソフトリミット**（バリア関数等）で滑らかに制限。  
- **swing / twist を分離**して適用し、ねじりの暴れを抑える。

### タッチ操作（FPD仕様：ロジック）
- **単指ドラッグ**  
  - ドラッグ開始時：焦点 F を決定し、`n = normalize(G − F)` を法線とする平面 Π を確定（ドラッグ中は固定）。  
  - ドラッグ中：タッチ位置から生成するレイと Π の交差点を新しいゴール位置とし、**該当チェーンのみ再解決**。  
  - `||G−F||` が極端に小さい場合は `n` をカメラ前方にフォールバック。
- **二指ピンチ / スワイプ**  
  - ゴールを法線方向にオフセット（`G を n 方向に移動`）。量はジェスチャに比例。  
- **二指回転**  
  - ゴールの**向き**を回転操作量に応じて更新。  
- **長押し**：ゴールの**ピン留め**（一時固定）。  
- **ダブルタップ**：ゴールの**リセット**。

### IKゴール選択（タップピッキング：ロジック）
- **前提**  
  - 各ゴールは**表示ハンドル**（一定画素サイズのビルボード）と、**不可視のピック用ボリューム**（球/カプセル）を持つ。
- **段階1：2D候補抽出**  
  - タップ座標と各ゴールの投影座標の距離が**ピック半径（px）以内**のものを候補にする。  
  - ピック半径は**DPIに応じてスケール**。
- **段階2：3D本判定＋遮蔽**  
  - 画面レイと各候補のピックボリュームの交差を取り、**最前面**のものを優先。  
  - 同レイでメッシュへの最短交差距離を取得し、**メッシュより手前**の候補のみを有効とする。  
  - **X-ray選択**（二本指タップ併用など）の時は遮蔽判定を無効化。
- **あいまいさ解決**  
  - スコアにより決定（主に「画面距離の近さ」を重視、次に「手前度」）。  
  - **ダブルタップ**で重なり候補を循環、**長押し**でラジアルメニューから直接選択。  
  - **スティッキー選択**：直前に操作したチェーンを次回優先。  
  - **ヒステリシス**：小移動では選択確定を保留し、誤ドラッグを抑制。
- **表示・スケール**  
  - ハンドルは距離に依らず**一定画素サイズ**で描画。  
  - ピックボリュームの実半径は、距離・FOVから**体感一定**となるよう算出。

## 描画/技術スタック
- **UI**: .NET MAUI
- **描画**: OpenTK（GL ES 3.x）
- **シェーダ**: トゥーン（基本）/ PBR（TBD）
- **アセット管理**: 非同期ロード、GPUメモリ最適化（TBD）

## 共有/配布ポリシー
- **出力は専用SNS的プラットフォームのみ**  
  - アプリから直接投稿（名称/API仕様はTBD）
  - 端末内ファイル出力は不可
  - 閲覧・再生・配布はプラットフォーム上で実施

## データフロー
```text
[PMX Model] --> [PMX Importer] --> [Scene/Bones]
[IK Handles] <--> [Solver] <--> [Rig] --> [Node/State Graph Playback]
[Motion Files (Import Only)] --> [Graph Nodes / States]
[Share] --> [Dedicated Motion Platform (Only)]
