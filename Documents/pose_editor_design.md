# ポーズエディター詳細設計書

## 1. ビュータブに「ポーズエディター」パネルを追加
- PMXモデル読み込み後、ビュータブに「ポーズエディター」を追加し、選択すると専用パネルを表示する。
- 既存の3Dビューはそのまま維持しつつ、ポーズ編集に必要な情報のみを表示するシンプルなパネルとする。
- パネルの主な要素
  - 操作説明や注意事項のテキスト
  - 今後の拡張を想定したボーン一覧や保存ボタン（現段階ではプレースホルダ）

## 2. モード切替スイッチ
- 画面右上に楕円形のトグルスイッチを配置する。
- 状態表示
  - **オフ（灰）**: カメラモード
  - **オン（緑）**: ポーズモード
- 挙動
  - **カメラモード**: 既存のカメラ操作（回転・移動・ズーム）が有効。
  - **ポーズモード**: カメラは固定され、マウス操作はIKボーン操作に割り当てられる。

## 3. 11個のIKボーンを自動生成
- VRChatのフルトラッキング構成を参考に以下の11点のIKボーンを自動生成する。
  1. Head
  2. Chest
  3. Hip
  4. Left Shoulder
  5. Right Shoulder
  6. Left Hand
  7. Right Hand
  8. Left Knee
  9. Right Knee
  10. Left Foot
  11. Right Foot
- PMXモデル読み込み後、ポーズモードへ初めて切り替えた際に生成する。
- 既存ボーン構造には影響を与えず、仮想的なIKボーンとして管理する。

## 4. ボーン操作アルゴリズム
1. **ボーン選択**
   - ポーズモード時に表示されるIKボーンをクリックして選択する。
2. **平面生成**
   - カメラのレンズ位置 \(C\) と選択ボーンの位置 \(B\) を結ぶ直線を法線とする平面 \(P\) を \(B\) を通るように定義する。
3. **マウス移動の投影**
   - マウスドラッグをスクリーン座標からワールド座標へ変換し、平面 \(P\) 上に射影して新しい位置 \(B'\) を得る。
4. **IK計算**
   - \(B'\) をIKボーンの新しい位置として設定し、対応するPMXボーンの角度を逆運動学で再計算する。
5. **視覚フィードバック**
   - 操作中のボーンをハイライト表示し、平面 \(P\) を半透明で描画する。

## 5. イベントフロー
1. ビュータブでポーズエディターを開く。
2. 右上スイッチをオンにしてポーズモードへ移行（カメラ固定、IKボーン表示）。
3. IKボーンを選択し、平面上でドラッグして位置調整。
4. IK計算結果がモデルに反映され、ポーズが更新される。
5. モードをオフに戻すとカメラ操作に復帰し、IKボーンは非表示となる。

---
以上の設計により、カメラ操作と直感的なIKボーン操作を切り替えながらポーズ作成が行える。
