VRChat IK 2.0を参考にした11点トラッキングIKシステム設計

背景と目的

VRChatのIK 2.0では、ヘッドセットやトラッカーによる最大11点のトラッキング（頭・両手・腰（ヒップ）・胸・両足・両膝・両肘）をサポートし、体の自然な動きを実現しています 。本設計では、このVRChat IK 2.0の仕組みを参考に、OpenGLベースの自作ダンス制作用エディタにおいて、実センサーなしで11箇所の「IKゴール」（仮想トラッカー）を手動操作し、アバターのポーズを自然に作成できるシステムを構築します。目標は、ユーザがIKハンドルをドラッグするだけで、腕・脚・腰・背中などの骨格が連動して自然に追従することです。

トラッキングポイントとIKゴールの設定

エディタ上では以下の11点に対応するIKゴールを配置します（VRChatにおけるトラッカー位置と対応） 。
	•	頭（Head）：頭部の位置・向きゴール。HMDに相当。
	•	両手（Left/Right Hand）：手首（手先）の位置・向きゴール。コントローラに相当。
	•	腰（Hip/Pelvis）：骨盤付近の位置ゴール。腰トラッカー相当（アバターのルート）。
	•	胸（Chest）：上半身（胸部）の位置・向きゴール。胸トラッカー相当（上半身の向きに影響）。
	•	両足（Left/Right Foot）：足首（足先）の位置・向きゴール。足用トラッカー相当。
	•	両膝（Left/Right Knee）：膝の位置ゴール（関節の向き制御用）。膝トラッカー相当。
	•	両肘（Left/Right Elbow）：肘の位置ゴール（上腕の向き制御用）。肘（上腕）トラッカー相当。

各IKゴールは対応するアバターボーンに紐づけられ、ユーザはゴールを移動・回転させることでその部位を目標位置/角度に誘導します。システムは逆運動学(IK)ソルバーを用いて、ゴールと骨格の位置関係から中間の関節角度を自動計算します  。これにより、手先や足先など末端の位置を決めるだけで、上位の関節（肩や股関節など）が自動調節されるため、直感的にポーズ付けが可能になります 。

IKソルバー方式の選択 (CCD vs FABRIK vs 解析解)

IK解決アルゴリズムには主にCCD（Cyclic Coordinate Descent）, FABRIK（Forward And Backward Reaching IK）, 解析的ソルバー（Analytic IK）の3種類があります。それぞれの特徴を踏まえ、本システムでは身体の部位ごとに適切な方式を使い分けます。
	•	CCD方式: 末端から順に各関節を目標に向けて回転させる反復的手法です。計算コストが低くリアルタイム性に優れ、小～中程度の長さのチェーンに適しています 。例えば比較的短いIKチェーン（肩～手首など）では軽量で効果的とされています 。一方で、各関節が個別に目標へ向かおうと過回転しがちで、長いチェーンでは全体として不自然に絡まる解になりやすい欠点があります  。実際、CCDは「自分とエンドエフェクタ間のベクトルだけを考慮し、チェーン全体の整合性を考えない」ため極端な姿勢では鎖がもつれることがあります 。またCCDIK（UE4実装）では角度制限を扱える反面、関節数が多い長いIKチェーンでは良くない解に落ち着く可能性が指摘されています 。
	•	FABRIK方式: 関節位置を目標に向けて前方・後方に直線的に収束させる反復法です。回転計算を使わずにジョイント位置を更新するため収束が速く、多数の関節からなる長いチェーンでも安定して滑らかな解を得られるのが利点です 。FABRIKは計算量が少なく高速なアルゴリズムで、特に長肢のIKや多関節のスケルトンに適しているとされています 。関節全体にバランスよく変位を分配するため、鎖全体が自然にたわむような見た目になる傾向があります 。一般にFABRIKはCCDより少ない反復回数で収束するため、長いチェーンではパフォーマンス上有利になりえます （※ただし拘束条件を増やすと1回の反復コストは上がるので状況による）。
	•	解析解 (Analytic IK): 数学的な閉形式で直接関節角度を解く方法です。特定の構造（通常2つか3つの関節からなる平面内チェーン）に限定すれば反復なしで厳密解を計算できます。例えば2ボーンIK（大腿と脛で足先位置を決める等）では三角法（余弦定理など）で効率的に角度を算出可能です 。チェーンが特定平面内に収まるよう制限すれば3次元でも利用でき、繰り返し法より高速です 。解析解は汎用性には欠けますが、頻繁に計算する必要がある特定IK問題では有力であり 、ゲーム開発でも標準的な2ボーンIKとして多用されています。

以上を踏まえ、本システムでは**「短いIKチェーンにはCCDまたは解析解を、長いIKチェーンにはFABRIKを使用」する方針とします 。特に腕や脚など2関節のチェーン**には解析解を適用し、高速で確実な到達を図ります。一方、脊柱など複数関節にわたる長いチェーンにはFABRIKを用いて滑らかに姿勢を調整します。以下、部位ごとに具体的なIKチェーン構成と制御方法について詳述します。

各部位ごとのIK設計

腰・脊柱・胸部のIK（腰・胸ゴール）

対象ゴール: 腰（ヒップ）位置、胸位置（および上半身の向き）。
担当ボーン: 骨盤～脊柱（腰椎～胸椎）～首～頭。

腰から頭にかけての胴体部分は複数ボーンから成る長いチェーンであり、加えて上下双方にトラッカー目標（腰と胸、場合によっては頭）があります。そこでFABRIK方式のフルボディIKを採用し、胴体全体を柔軟にターゲット位置へフィットさせます 。具体的には、以下のような段階的ソルブを行います。
	•	腰～胸（脊柱）チェーン: 骨盤（ヒップ）ボーンから胸部ボーン（上半身の中心）までの脊椎ボーン列にFABRIKを適用します。腰ゴール（ヒップ）は通常アバターのルートとして固定アンカーとし、胸ゴール（位置・向き）に向かって背骨を前方計算で伸ばし、逆方向に収束させることで、胸ボーンを目標に一致させます  。こうすることで、腰を基点として上半身が自然な曲線を描きながら胸の位置・向きへと到達します。FABRIKは回転ではなくジョイント位置ベースで調整するため、各背骨ボーンの回転が滑らかに分散され、極端な屈折やねじれが生じにくい利点があります 。
	•	首～頭チェーン: 胸（肩）から首・頭にかけての上部チェーンは比較的短い（2ボーン程度）ため、CCDあるいは簡易な解析的手法で解決可能です。頭ゴール（HMD相当）が提供される場合、頭部ボーンをゴール位置・向きに一致させるのが目標です。首と頭の2ボーンについては、例えば「頭ボーンの向きをターゲットに直接合わせ、残差を首ボーンの回転で補正する」ような2段階の解析解で処理できます。あるいはCCDで首から順に頭をターゲットに向けても問題ありません（チェーンが短いためCCDでも安定して収束します）。重要なのは、**視線の向き（頭の回転）**を正確にゴールに追従させることです 。頭ゴールには姿勢（回転）も含めて操作できるようにし、ユーザが見せたい方向を指定すれば首・頭がそれに沿うよう調整します。
	•	ロックオプション: 胸と頭の両方に位置ゴールが存在する場合、胸～首～頭の距離関係によっては両方を厳密に満たすことが困難なケースがあります。VRChat IK 2.0でも、頭と腰トラッカーを同時に固定すると背骨に無理が生じるため、**「頭優先」「腰優先」「両方固定」**のロックモードが用意されています 。本システムでも極端な姿勢での不自然さを避けるため、例えば「腰（ヒップ）を固定し頭は若干妥協する」か「頭（ビュー位置）を優先し腰位置を僅かにずらす」といったオプションを検討します 。デフォルトでは腰ゴールを固定アンカーとし、頭位置が多少ずれても視線方向を維持する（Lock Hipモードに類似）設定が無難です 。ユーザが必要に応じてモードを選べるようにし、胴体の曲がり具合と目標位置の厳密さをトレードオフできる設計が望ましいでしょう。
	•	胸トラッカーの扱い: 胸ゴールは主に上半身のねじれ（ツイスト）と前傾/後傾を制御します。最新のVRChatでは胸トラッカーの位置と回転が常に利用され、Lock Allモードを選ばなくても位置情報が反映されます。エディタではユーザが胸ゴールを位置ごと動かせるようにするか、回転ハンドルのみにするか選択肢があります。フルに操作可能にすると背骨への負荷が大きいため、デフォルトは胸ゴールは回転操作のみ受付け、位置は腰と頭から自動算出された中間に置く方法が考えられます。こうすることで、胸トラッカーは上半身の捻り（Y軸回りの回旋）や左右の傾きをユーザが調整するためのポールターゲット的役割とします。必要に応じて胸ゴールの位置操作も解放し、極端な体幹動作（大きくのけ反る等）を作りたい場合には一時的に胸位置も指定できるようにする柔軟性を持たせます。
	•	ツイスト補正: 胴体の捻じれについては、複数の脊椎ボーンで均等に分配するのが自然です。例えば胸ゴールが真後ろを向くような場合、一箇所の骨（例えば腰の1箇所）で180度回旋させるのではなく、腰～胸の各ボーンが少しずつ合計180度ひねるようにします。これは**Twist Correction（ツイスト補正）**と呼ばれる手法で、UnityのAnimation Riggingにも肩や腰などのねじれ変形を複数ボーンに再分配するコンストレイントが用意されています 。本システムでも、脊柱IKを解いた後に胸ボーンの軸回りの回転を下位の背骨ボーンに%配分して伝える処理を行うことで、胴体メッシュのねじれ歪みを軽減します 。

脚部のIK（足先・膝ゴール）

対象ゴール: 左右の足先（足首）位置・向き、膝位置。
担当ボーン: 大腿（腿）ボーン、脛ボーン、足首ボーン（必要なら足先・つま先ボーン）。

両脚は典型的な2ボーンチェーンであり、高速かつ安定した解析的IKを適用します。各脚について、股関節（大腿の付け根）から足首までの2つの関節角度を直接計算し、足先ゴールに一致させます。具体的な手法はゲーム開発で実績のあるTwo-Bone IK（2ボーンIK）の解析解です。これは以下のように行います:
	•	2ボーン解析解: まず大腿骨と脛骨の長さ、および股関節から目標足先までの距離を算出します。余弦定理により膝の曲げ角度（膝関節角）を求め、次に目標方向に対する股関節の角度を計算します  。解が存在する条件（足先までの距離が骨の長さの和以内であること等）をチェックし、届かない場合は骨を最大限伸ばした姿勢、近づきすぎる場合は折りたたんだ姿勢となるよう、到達不可能時の代替姿勢も計算します  。解析解なので反復計算は不要で、一発で膝角度と股関節角度のセットを得ることができます 。このアルゴリズムは計算量が一定で軽く、リアルタイムで頻繁に呼び出しても性能上有利です 。
	•	膝のポールターゲット: 2ボーンIKでは解が1平面内に定まるため、どの方向に膝が曲がるかを指定する必要があります （解が2つ存在するため）。これに対応するのがポールターゲットと呼ばれる仕組みで、膝の向きを制御するための補助ターゲットです 。各膝についてエディタ上に膝ゴールを用意し、これは直接膝関節に紐づけず膝の曲がる平面を決めるための目印とします。具体的には、膝ゴール方向に膝関節が向くようにIK解を採用します 。例えば正面から見て膝ゴールがやや前方にあれば膝は前に曲がり、内側に置けば内股気味になる、という具合です。ユーザは膝ゴールを操作することで膝の開き具合や向きを微調整できます 。なお初期姿勢では膝ゴールを各膝のやや前方に自動配置し、自然な前方曲げがデフォルトになるようにします。
	•	膝トラッカーの利用: もし実際のトラッカー情報（もしくはユーザが膝ゴールを厳密に配置する場合）があるなら、その膝位置をIK計算結果ができるだけ通るよう調整します。理論上、股関節～膝～足首の位置関係は2ボーンIKで一意に決まりますが、膝ゴールとずれがある場合は若干の修正を加えます。例えばCCDを一歩だけ膝に対して実行し、大腿ボーンを膝ゴールに近づける微調整を入れてから解析IKを解く、といったハイブリッドも考えられます。VRChat IK 2.0では膝トラッカーはIK計算に組み込まれ、膝と肘が胴体を貫通しないよう自動補正されています 。エディタでも同様に、膝ゴールが有効な場合は計算された膝関節位置をゴール位置へスナップ or 補間する処理を入れ、ユーザ意図通りの膝位置を反映させます。もっとも、通常はポールターゲット操作で十分膝方向を調整できるため、膝ゴールを厳密な「位置固定」とするよりヒント（Hint）として利用する方が安定です。
	•	足首と足裏の向き: 足先ゴールには**位置だけでなく向き（回転）**も設定できるようにします。こうすることで、足裏を床に接地させた姿勢やつま先立ち等を正確に再現できます。IK計算ではまず位置を合わせ、その後でゴールの回転に合わせて足首ボーンを捻って揃えます。足首の回転は脛ボーンの計算には影響しないため（末端エフェクタの回転自由度）、末端ボーンの回転制御は独立に適用できます。これにより、ユーザが足ゴールを回転させれば、足裏の向きや靴先の方向も自在に調整できます。
	•	ツイスト補正（脚）: 大腿やふくらはぎにも捻り用の補助ボーン（いわゆるTwist bone）がある場合、それらにもねじれ分散をします 。例えば足先を外側に大きく向けた場合、股関節ひとつで90度回旋するのではなく、大腿のメインボーンとTwistボーンがそれぞれ45度ずつ回旋する、といった具合です 。UnityのTwist Correction Constraintなどを参考に、大腿の軸回り回転を補助ボーンに割合配分する仕組みを導入すると、脚のねじれ変形による肌のつっぱりを和らげられます 。

腕部のIK（手先・肘ゴール）

対象ゴール: 左右の手先（手首）位置・向き、肘位置。
担当ボーン: 上腕ボーン、前腕ボーン、（必要に応じて鎖骨ボーン）。

腕も脚と同様に2つの骨（上腕・前腕）で構成されるチェーンなので、2ボーンIKの解析解を用います。肘関節の曲げ角度と肩関節の向きを直接計算し、手先ゴールに到達させます。基本的な手順は脚IKと同様で、上腕と前腕の長さから肘角度を余弦定理で算出し、次に肩の角度を決定します  。この際、肘の曲げ方向を決める必要があるため、肘ゴール（ポールターゲット）を用意します 。各肘ゴールの方向に肘関節が向くようにIK解を採用することで、腕が上下どちらに曲がるか、内向きか外向きかを制御できます 。初期設定では肘ゴールを肘のやや後方（体の外側）に配置し、肘が自然に後ろ寄りに曲がるようにします。ユーザは肘ゴールを動かすことで肘の張り具合を調節可能です 。

肘トラッカー活用: VRChat IK 2.0では、上腕に装着した単一のトラッカーで肘と肩の両方を制御する仕組みがあります 。これは肘上のトラッカーから上腕の姿勢を検出し、肩関節（鎖骨）と肘の向きを補正するものです 。エディタにおいて肘ゴールを有効にした場合、可能なら上腕骨への直接的な姿勢適用を行います。例えば、ユーザが肘ゴールをキャラクターの外側遠くに配置したなら、それは「上腕が体から離れる向きに回旋している」ことを意味するため、肩関節を若干上げる（鎖骨を回転する）処理を入れます。実装としては、解析IKで求まった肩・肘角度に対し、肘ゴール方向へのずれを肩関節の追加回転で埋めるようなフィードバックを入れると良いでしょう。あるいは、肘トラッカー（ゴール）の位置そのものをIKチェーンの中間目標とみなし、3ボーンIK（鎖骨＋上腕＋前腕）をFABRIKやCCDで解いても構いません。簡便には、肘ゴールをポールターゲット以上・完全な位置目標未満の扱いとし、通常は解析2ボーンIK、肘トラッカー使用時のみ肩回りの微修正を加える実装が考えられます。

肩・鎖骨の考慮: モデルによっては肩（鎖骨）ボーンが独立して存在し、上腕の付け根を微調整できる場合があります。鎖骨は腕全体の上下動に影響する短い骨なので、IKチェーンに含めず事後的に補正する方がシンプルです。たとえば、IK計算後に手先ゴールと実際の手先位置の誤差を見て、肩ボーンを若干回すことでその誤差を減らす、といった手法です。これにより腕を上に大きく上げた際などに鎖骨が自然と持ち上がり、より現実的な肩の動きになります（MMDモデルの「肩ボーン」に相当）。VRChatでも肘上トラッカーを肩と肘にマップする際に肩ボーンを動かしています 。エディタでは簡易的に、腕が水平より上に上がったら肩ボーンも回旋させる、といったルールベースでも十分です。

手首の向き: 手先ゴールには回転操作も可能とし、手のひらの向きや指先の方向を指定できるようにします。IK計算自体は手首位置までで完了し、最後にゴールの回転に合わせて手首ボーン（または手ボーン）を回旋させます。例えば手のひらを下に向ける、拳を軽く内側に捻る、といった微妙な手首のひねりもユーザが直接コントロールできます。これにより、物を握るポーズや手のひらの向きが重要なダンスの型も忠実に再現できます。

ツイスト補正（腕）: 上腕や前腕にもツイスト用ボーンがある場合は、肩から手首にかけての捩じりをそれらに配分します 。特に上腕は肩に近いほどボリュームがあり捩じり変形が目立つため、肩関節の軸回り回転を上腕のツイストボーンに半分程度移譲すると良い結果になります 。UnityのTwist Correctionでは肩や手首をソースに複数のツイストノードへ回転を%分配できますが、原理的には本システムでも上腕の回旋角度の○%を肩側のTwistボーンに与えるといった設定が可能です 。これにより、例えば腕を内ひねりした際に肘周りだけでなく上腕全体でねじれるため、メッシュの潰れが緩和されます 。なおIK自体はツイスト骨を直接は動かさないため、IK計算完了後に補正コンストレイントを適用する形になります。

頭部のIK（頭ゴール）

頭部については既に脊柱チェーン内で触れましたが、補足します。頭ゴールは通常、HMDの位置・姿勢に対応するものとして頭の位置と向きを指定します。VRChatではHMDの向きが直接アバターの頭の向きに適用されます  。エディタでも同様に、ユーザが頭ゴールを回転させればアバターの顔の向きがそれに一致するようにします。内部的には首～頭の短いチェーンでCCDもしくは直接制御を行います。例えば**「頭ボーンのローカル回転＝ゴール回転」とし、首ボーンは位置合わせのために少し傾ける程度のシンプルな実装でも十分でしょう。頭部は他の部位に比べて可動範囲も小さいため、IKというよりターゲットに追随する1ボーン**として扱っても問題ありません。

姿勢の都合上、頭ゴールの高さをユーザが大きく動かすと首が極端に伸び縮みする可能性があります。そこで通常は頭ゴールは回転操作メインとし、位置は胸ゴールとともに脊柱IKで自動的に決まるようにします。必要があれば頭ゴール位置も操作可能にし、例えばキャラクターが背伸びしたり沈んだりする演出で頭位置を独立に調整できる柔軟性も持たせます。

エディタでのIKゴール操作・チェーン登録とリアルタイム解決

IKゴールの配置と操作方法

エディタ上では、各IKゴールを**視覚的なハンドル（ギズモ）**として表示します。ユーザはマウスドラッグ等でこれらのハンドルを掴み、移動（位置）や回転を直接操作できます。IKゴールは一般に3軸の矢印や回転リングで示され、自由に動かせるようにします。例えば足先ゴールなら足首付近にターゲット用の小さな球体や矩形を表示し、これをドラッグすれば足を引っ張ったり持ち上げたりできます。回転モードに切り替えればその球体を回転させ、足先の向きを調整できます。

ゴールの初期配置は読み込んだモデルの初期姿勢に合わせ、自動的に各骨の位置へ配置します。ユーザが新たにIKを設定したい場合、手順としては:
	1.	IKゴールの作成: モードを「IK編集」に切り替え、操作したい末端ボーン（例: 手首）を選択して「IKゴールを追加」ボタンを押すと、そのボーン位置にゴールオブジェクトが生成されます。プリセットとして人型モデルの場合は初期から頭・両手・両足にゴールが作成されていてもよいでしょう。
	2.	チェーンの登録: ゴールに対応するIKチェーン（影響させる骨リスト）を決定します。通常はゴールから親方向へ一定数の骨を遡った範囲がチェーンとなります。例えば手首ゴールなら親である前腕・上腕（肩まで）をチェーンとします。脚なら足首から脛・大腿（股関節まで）をチェーンにします。あらかじめ標準的な人型ボーン名（UpperArm, LowerArm, etc.）にマッチさせて自動登録するか、ユーザがGUI上で「このゴールに含めるボーン数」を指定できるようにします。一般的には手首・足首ゴールは2ボーン、肘・膝のポールターゲットはそれぞれ肘や膝関節単体を指し、腰・胸・頭ゴールはそれぞれ脊柱全体あるいは1ボーン扱いとなります。
	3.	操作: ゴールが配置されたら、あとはドラッグ＆ドロップで動かすだけです。例えば足IKなら、足先ゴールを動かすとリアルタイムに足がIK計算で追従し、膝も自動で曲がります。手を動かせば肘が曲がり肩が連動します。ポーズの保存やキー設定もできるようにし、各ゴールの位置を記録すればアニメーションのキーを打つことも可能です。

各IKゴールはオン/オフを切り替え可能にしておくと便利です。例えば細かな指の調整中に足IKは固定しておきたい場合、足IKゴールを無効化すれば一時的にFKモードになり誤って足がずれる心配がなくなります。同様に腰ゴールを無効にすると腰はFKのままとなり、上半身だけIKで操作する、といった部分的な切り替えも可能にします。これはFK/IKブレンド機能とも言え、アニメ制作時によく使われる手法です 。本エディタではゴールごとにIK解決を適用するかどうか選択肢を与え、ユーザが状況に応じてFK操作との使い分けをしやすくします。

リアルタイムIKソルブの流れ

ユーザがIKゴールを動かすたびに、その変更を反映して各チェーンのIKソルバーをリアルタイム実行します。実装上はエディタの描画フレームごと、もしくはゴールのドラッグイベントごとにIK解決関数を呼び出し、対応する骨の回転を更新します。ここで重要なのはソルブの順序と依存関係です。全身が複雑に連動するため、適切な順序でIKを解かないと競合や振動が起きる可能性があります。

推奨されるソルブ順序は、一般に胴体→四肢の順です。まず腰・脊柱IKを解決し体幹の姿勢を決定してから、腕や脚を解決します。理由は、例えば手足の基部（肩や股関節）は胴体に付随して動くため、胴体位置が確定してからでないと正確な手足の目標相対位置が定まりません。具体的には:
	1.	胴体の配置: 腰ゴールにより骨盤ボーンの位置を設定（あるいは固定）。次にFABRIKで脊柱チェーンを解き、胸ボーン（と必要なら頭ボーン）を配置します。これで体のコア部分の姿勢が決定します。
	2.	頭の向き: 首～頭チェーンを解いて頭の最終角度を合わせます（胴体ソルブと同時でも可）。
	3.	脚のIK: 左右の足について、それぞれ腰（骨盤）の位置を起点に2ボーンIKを解決します。足先ゴールに合わせて膝角度と股関節角度を設定し、必要ならFABRIK反復で膝ゴールとの差を微調整します。床との当たり判定などがある場合は、この段階で足先を床上に拘束する処理も加えます。
	4.	腕のIK: 左右の腕について、肩（鎖骨）は胸ボーンに付いているため既に位置確定しています。その肩基準で2ボーンIKを解き、手先ゴールに合わせます。肘ゴールや肘トラッカーを考慮し、必要なら肩ボーンの補正やFABRIK微調整を行います。
	5.	微調整・コンストレイント: 解析IKやFABRIKで得た結果に対し、ツイスト補正や角度制限などの調整を適用します。例えば膝や肘が物理的に逆方向に曲がらないよう制限したり、足首の回転を地面に対して水平に保つよう補正したりする処理です。
	6.	結果の適用: 計算された各ボーンの回転値をアバターのボーン姿勢に反映し、レンダリングを更新します。

以上の計算は十分高速であり、現在のPC性能ではリアルタイムで実行しても支障ありません。特に解析解部分は定数時間で、FABRIKやCCDもチェーンが短ければ数ステップの反復で収束します。さらに最適化として、動かしていないチェーンの再計算を省略することも可能です。例えば腕だけ動かした場合、脚IKは前回結果を保持したままでもよいでしょう。このように必要最低限のIKソルブにとどめることで、大規模なモデル（高ボーン数）でも編集が快適に行えます。

チェーンとゴールの管理UI

アプリ開発者向けの実装ポイントとして、IKチェーンとゴールを管理する仕組みを整えておきます。各ゴールは関連付けられたボーンとチェーン長、ポールターゲットの有無などの情報を持ちます。ユーザがゴールを追加・削除したり、ゴールに含めるボーン範囲を調整できるUIを提供すると、様々なリグ（骨格構造）への適応が容易になります。例えば人型以外のキャラクター（尻尾や翼など）にもIKを使いたい場合、その部分の末端ボーンにゴールを設定しチェーンを登録すれば同様の操作性を実現できます。

内部的には、IKソルバーごとにSolverクラスを用意し、チェーンのボーン配列とターゲット（ゴール）をセットしておきます。各フレームでsolver.solve()を呼び出すとボーンの姿勢が更新されるようにします。CCDソルバーやFABRIKソルバー、2ボーン解析ソルバーをそれぞれ実装し、チェーンの長さや用途に応じて使い分けます。エディタ上でユーザがチェーンのパラメータ（例えばFABRIKの許容誤差や最大反復回数）を調整できるようにしておくと、細かなチューニングも可能になります。

最後に、IKのオンオフ状態やゴールの位置などはプロジェクトデータとして保存・読み込みできるようにします。こうすることで、ユーザはあるポーズを作った後、一旦IKをオフにして手動調整し、またIKをオンに戻すといった作業を挟んでも、ゴール位置が保持され再度同じIKポーズに戻すことができます。VRChatではキャリブレーション結果を保存し異なるアバター間で使い回す機能がありますが  、本エディタでもIKターゲットのキャリブレーション（ポーズセット）を保存しておき、異なるモデルに適用する、といった応用も考えられます。

以上が、VRChat IK 2.0の11点トラッキング構成を参考にしたダンス用エディタ向けIKシステムの詳細設計です。IKハンドルをドラッグするだけで自然なポーズ付けができるよう、各部位に最適なIKアルゴリズムを割り当て、補助ターゲットやツイスト補正で安定性とリアリズムを高めています。適切なUIと管理機構を用意することで、ユーザ／開発者にとって扱いやすいIKエディタを実現できるでしょう。

参考資料: VRChat IK 2.0アップデート情報  、Unreal Engine IK手法に関するQA  、Blenderリギングノート 、Unity Animation Riggingマニュアル など。
